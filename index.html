<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>خريطة حفر الباطن عالية الدقة</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      background: #000;
      font-family: "TheSansArabic", sans-serif;
    }
    #map {
      height: 100%;
      width: 100%;
    }
    .leaflet-popup-content {
      text-align: center;
      direction: rtl;
      font-size: 14px;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <script>
    // === Initialize map centered on Hafar Al-Batin ===
    const map = L.map("map", {
      center: [28.4322, 45.9708], // 🏙️ City center
      zoom: 13,                   // ⬅️ Zoomed out to see full city area
      minZoom: 8,
      maxZoom: 22,                // 🔍 High detail available
      zoomControl: true,
    });

    // === ESRI World Imagery (High-Resolution Satellite) ===
    const esriSatellite = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      {
        maxZoom: 22,
        attribution: "© Esri, Maxar, Earthstar Geographics",
      }
    ).addTo(map);

    // === ESRI Label Layer (shows street names, places, buildings) ===
    const esriLabels = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}",
      {
        maxZoom: 22,
        opacity: 1,
        attribution: "© Esri",
      }
    ).addTo(map);

    // === Marker handling ===
    let markers = [];
    let selectedMarker = null;

    // --- Receive data from Grafana ---
    window.addEventListener("message", (event) => {
      if (!event.data || event.data.type !== "habData") return;

      markers.forEach((m) => map.removeLayer(m));
      markers = [];

      const regionData = event.data.data || [];
      if (!regionData.length) return;

      regionData.forEach((r) => {
        const marker = L.circleMarker([r.lat, r.long], {
          radius: 8,
          color: "#ff0000",
          fillColor: "#ff0000",
          fillOpacity: 0.9,
          weight: 1.5,
        })
          .addTo(map)
          .bindPopup(`<b>${decodeURIComponent(r.name)}</b>`)
          .on("click", () => {
            // Reset previous
            if (selectedMarker) {
              selectedMarker.setStyle({
                color: "#ff0000",
                fillColor: "#ff0000",
                radius: 8,
              });
            }

            // Highlight current
            marker.setStyle({
              color: "#ffff00",
              fillColor: "#ffff00",
              radius: 11,
            });
            selectedMarker = marker;

            // Send region to Grafana (without reload)
            window.parent.postMessage(
              {
                type: "mapClick",
                region: decodeURIComponent(r.name),
              },
              "*"
            );
          });

        markers.push(marker);
      });

      if (regionData.length > 1) {
        const bounds = L.latLngBounds(regionData.map((r) => [r.lat, r.long]));
        map.fitBounds(bounds, { padding: [40, 40] });
      }
    });
  </script>
</body>
</html>
